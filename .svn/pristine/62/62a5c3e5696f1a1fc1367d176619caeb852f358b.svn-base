--AceEvent:RegisterEvent(event, callback, args)
local L = LibStub("AceLocale-3.0"):GetLocale("GearHelper")

local prefixAddon = "GeARHeLPeRPReFIX"
function addonLoaded(name)
    --print(name.." - "..addonName)
    if name == addonName then


      -- charge le préfix de l'addon (ou un truc du genre)
      RegisterAddonMessagePrefix(prefixAddon)

      -- Active l'addon par défaut lors de la première connexion après l'installation
      -- if GHVarChar.addonOptions == nil then
      --   setDefault()
      --
      --   waitNilTimer = time()
      --   waitNilFrame:Show()
      -- end

      print(L["merci"])

      if GHVarChar.lastItem ~= "" and GHVarChar.lastItem ~= nil then
        C_Timer.After(10, function()
          createLinkAskIfHeNeeds(0, GHVarChar.lastItem.message, nil, nil, nil, GHVarChar.lastItem.target)
          GHVarChar.lastItem = ""
        end)
      end

    end
end

function merchantShow()
  gagne = 0
  if GearHelper.db.profile.sellGreyItems then
    for bag = 0, 4 do
      for slot = 1,GetContainerNumSlots(bag) do
        if GetContainerItemID(bag, slot) ~= nil then
          id = GetContainerItemID(bag, slot)
          if id then
            result = test.SiObjetGris(id)
            if result[1] then
              UseContainerItem(bag, slot)
              gagne = gagne + result[2]
            end
          end
        end
      end
    end
  end

  if CanMerchantRepair() and GearHelper.db.profile.AutoRepair == 1 or GearHelper.db.profile.AutoRepair == 2 then
    local argentPossedee = GetMoney()
    local prix = GetRepairAllCost()
    if IsInGuild() and CanGuildBankRepair() then
      local droitGuilde = GetGuildBankWithdrawMoney()
      local argentGuilde = GetGuildBankMoney()
    end
    if prix > 0 then
      if GHVarChar.addonOptions["RepairWithOwnGold"] then
        if argentPossedee >= prix then
          RepairAllItems(false)
          print(cRose..L["repairCost"]..math.floor(prix/10000)..L["dot"]..math.floor((prix % 10000) / 100)..L["gold"])
        else
          print(L["CantRepair"])
        end
      elseif GHVarChar.addonOptions["RepairWithGuildGold"] then
        if droitGuilde ~= nil and (droitGuilde == -1 or (droitGuilde > argentGuilde and argentGuilde > prix)) then
          RepairAllItems(true)
          print(cRose..L["guildRepairCost"]..math.floor(prix/10000)..L["dot"]..math.floor((prix % 10000) / 100)..L["gold"])
        else
          if argentPossedee >= prix then
            RepairAllItems(false)
            print(cRose..L["repairCost"]..math.floor(prix/10000)..L["dot"]..math.floor((prix % 10000) / 100)..L["gold"])
          else
            print(L["CantRepair"])
          end
        end
      end
    end
  end

  --pour tous les sacs du jour
  -- pour tous les items du sac
  -- argentDépart += prixItem
  --end
  --end
  for bag = 0,4 do
    for slot = 1,GetContainerNumSlots(bag) do
      if GetContainerItemID(bag, slot) ~= nil then
        local _, itemCount = GetContainerItemInfo(bag, slot)
        id = GetContainerItemID(bag, slot)
        if id then
          _, _, _, _, _, _, _, _, _, _, vendorPrice = GetItemInfo(id)
          if vendorPrice ~= nil then
            gagne = gagne + (vendorPrice * itemCount)
          end
        end
      end
    end
  end
end


GearHelper:RegisterEvent("ADDON_LOADED", addonLoaded, name)
GearHelper:RegisterEvent("MERCHANT_SHOW", merchantShow)
