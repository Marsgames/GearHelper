local L = LibStub("AceLocale-3.0"):GetLocale("GearHelper")

local prefixAddon = "GeARHeLPeRPReFIX"
local gagne = 0

waitingIDTable = waitingIDTable

--[[
Function : AddonLoaded
Scope : local
Description :
Input :
Output :
Author : Raphaël Daumas
]]
local function AddonLoaded(name)
	if GearHelper.db.global.templates == nil then
		GearHelper.db.global.templates = {}
	end

	GearHelper:InitTemplates()

	if name == addonName then
		RegisterAddonMessagePrefix(prefixAddon)
		print(L["merci"])
	end
end

--[[
Function : OnMerchantShow
Scope : local
Description :
Input :
Output :
Author : Raphaël Daumas
]]
local function OnMerchantShow()
	gagne = 0
	if GearHelper.db.profile.sellGreyItems then
		for bag = 0, 4 do
			for slot = 1,GetContainerNumSlots(bag) do
				if GetContainerItemID(bag, slot) ~= nil then
					local id = GetContainerItemID(bag, slot)
					if id then
						local result = GearHelper:SiObjetGris(id)
						if result[1] then
							UseContainerItem(bag, slot)
							gagne = gagne + result[2]
						end
					end
				end
			end
		end
	end

	if CanMerchantRepair() and GearHelper.db.profile.autoRepair == 1 or GearHelper.db.profile.autoRepair == 2 then
		local argentPossedee = GetMoney()
		local prix = GetRepairAllCost()
		local droitGuilde = ""
		local argentGuilde = ""

		if IsInGuild() and CanGuildBankRepair() then
			droitGuilde = GetGuildBankWithdrawMoney()
			argentGuilde = GetGuildBankMoney()
		end
		if prix > 0 then
			if  GearHelper.db.profile.autoRepair == 1 then
				if argentPossedee >= prix then
					RepairAllItems(false)
					print(cRose..L["repairCost"]..math.floor(prix/10000)..L["dot"]..math.floor((prix % 10000) / 100)..L["gold"])
				else
					print(L["CantRepair"])
				end
			elseif GearHelper.db.profile.autoRepair == 2 then
				if droitGuilde ~= nil and (droitGuilde == -1 or (droitGuilde > argentGuilde and argentGuilde > prix)) then
					RepairAllItems(true)
					print(cRose..L["guildRepairCost"]..math.floor(prix/10000)..L["dot"]..math.floor((prix % 10000) / 100)..L["gold"])
				else
					if argentPossedee >= prix then
						RepairAllItems(false)
						print(cRose..L["repairCost"]..math.floor(prix/10000)..L["dot"]..math.floor((prix % 10000) / 100)..L["gold"])
					else
						print(L["CantRepair"])
					end
				end
			end
		end
	end

	for bag = 0,4 do
		for slot = 1,GetContainerNumSlots(bag) do
			if GetContainerItemID(bag, slot) ~= nil then
				local _, itemCount = GetContainerItemInfo(bag, slot)
				local id = GetContainerItemID(bag, slot)
				if id then
					local _, _, _, _, _, _, _, _, _, _, vendorPrice = GetItemInfo(id)
					if vendorPrice ~= nil then
						gagne = gagne + (vendorPrice * itemCount)
					end
				end
			end
		end
	end
end

--[[
Function : OnMerchantShow
Scope : local
Description :
Input :
Output :
Author : Raphaël Daumas
]]
local function PlayerEnteringWorld()
	GearHelper:BuildCWTable()
	if GearHelper.db.profile.addonEnabled == true then
		GearHelper:sendAskVersion()
		GearHelper:scanCharacter()
		GearHelper:scanBag()
	end
end

--[[
Function : ChatMsgAddon
Scope : local
Description :
Input :
Output :
Author : Raphaël Daumas
]]
local function ChatMsgAddon(prefixMessage, message, sender)
	if prefixMessage == prefixAddon then
		local emetteur = ""
		if sender:find("-")then
			emetteur = sender:sub(0, (sender:find("-") - 1))
		else
			emetteur = sender
		end
		if GearHelper.db.profile.addonEnabled== true then
			if emetteur ~= GetUnitName("player") then
				local prefVersion = message:sub(0, (message:find(";") - 1))
				if prefVersion == "answerVersion" then
					local vVersion = message:sub(message:find(";")+1, #message)
					versionCible = vVersion
					GearHelper:receiveAnswer(vVersion, sender)
				end
				if prefVersion == "askVersion" then
					GearHelper:sendAnswerVersion()
				end
			end
		end
	end
end

--[[
Function : ItemPush
Scope : local
Description :
Input :
Output :
Author : Raphaël Daumas
]]
local function ItemPush(bag)
	if GearHelper.db.profile.addonEnabled then
		GearHelper:scanCharacter()
		GearHelper:scanBag()
	end

	if GearHelper.db.profile.autoEquipLooted.actual then
		if bag == 23 then
			numBag = 4
		elseif bag == 22 then
			numBag = 3
		elseif bag == 21 then
			numBag = 2
		elseif bag == 20 then
			numBag = 1
		else
			numBag = bag
		end
		waitEquipTimer = time()
		waitEquipFrame:Show()
	end
end

--[[
Function : QuestComplete
Scope : local
Description :
Input :
Output :
Author : Raphaël Daumas
]]
local function QuestComplete()

	GearHelper.GetQuestRewardCoroutine = coroutine.create(function() GearHelper:GetQuestReward() end)
	coroutine.resume(GearHelper.GetQuestRewardCoroutine)
	-- --Si item
	-- ----Si GetItemInfo()
	-- ------weightCalculation + recupère le meilleur ou le plus cher
	-- ----Sinon
	-- ------On sauvegarde la fonction (QuestComplete()) dans une variable
	-- ------On add l'item ID dans les itemsNoCached
	-- ------do return end
	-- ------
	-- ------quand GetItemInfoReceived recoit l'id, on réexecute la fonction sauvegardée
	-- ------Supprimer la fonction de la variable
	-- --Fin
	-- local weightTable = {}
	-- local prixTable = {}
	-- local altTable = {}
	--
	-- if GearHelper.db.profile.autoAcceptQuestReward then
	--     if GetNumQuestChoices() < 1 then --and GetQuestItemLink("choice", 1) ~= nil then
	--         GetQuestReward()
	--     elseif GetNumQuestChoices() == 1 then
	--         GetQuestReward(1)
	--     else
	--         for i = 1, GetNumQuestChoices() do
	--             local objetI = GetQuestItemLink("choice", i)
	--             local _, _, _, _, _, typeI, _, _, _, _, itemSellPrice1 = GetItemInfo(objetI)
	--             if typeI ~= L["armor"] and typeI ~= L["weapon"] then
	--                 do return end
	--             end
	--             local res = GearHelper:weightCalculation(objetI)
	--             if res[1] ~= nil and res[1] > 0 or res[2]~= nil and res[2] > 0 then
	--                 if res[1] > 0 then
	--                     table.insert(weightTable, res[1])
	--                 else
	--                     table.insert(weightTable, res[2])
	--                 end
	--             else
	--                 table.insert(weightTable, -10)
	--
	--                 table.insert(prixTable, itemSellPrice1)
	--                 table.insert(altTable, itemSellPrice1, objetI)
	--             end
	--         end
	--
	--         local maxWeight = weightTable[1]
	--         local keyWeight = 1
	--         local maxPrix = prixTable[1]
	--         local keyPrix = 1
	--
	--         for i = 1, #weightTable do
	--             if weightTable[i] > maxWeight then
	--                 maxWeight = weightTable[i]
	--                 keyWeight = i
	--             end
	--         end
	--
	--         for i = 1, #prixTable do
	--             if prixTable[i] > maxPrix then
	--                 maxPrix = prixTable[i]
	--                 keyPrix = i
	--             end
	--         end
	--
	--         local prixTriee = prixTable
	--         table.sort( prixTriee )
	--
	--         -- print("prix table ----")
	--         -- foreach(prixTriee, print)
	--         -- print("fin prix table ------")
	--
	--         if typeI == L["monture"] or typeI == L["mascotte"] or subTypeI == L["monture"] or subTypeI == L["mascotte"] then
	--             do return end
	--         end
	--
	--         for k, v in pairs(L["TypeToNotNeed"]) do
	--             if typeI == v or subTypeI == v then
	--                 --print("on a rien need ?")
	--                 do return end
	--             end
	--         end
	--
	--
	--     end
	--
	--     --print("maxweight : "..maxWeight)
	--     if subTypeI ~= nil and subTypeI ~= L["reliqueAP"] and typeI ~= L["gemme"] then
	--         if maxWeight > 0 then
	--             GetQuestReward(keyWeight) -- normalement c'est bon
	--             do return end
	--         end
	--         GetQuestReward(keyPrix) -- normalement c'est bon
	--     else
	--         --print("subtype : "..tostring(subTypeI))
	--     end
	-- end
end

--[[
Function : StartLootRoll
Scope : local
Description :
Input :
Output :
Author : Raphaël Daumas
]]
local function StartLootRoll(number)
	-- classeEN est la même, quelle que soit la langue du client
	--local classeFR, classeEN, classeNumber = UnitClass("player")
	local link, name, _, _, _, canNeed, canGreed  = GetLootRollItemInfo(number)
	local _, _, _, _, _, itemType, itemSubType = GetItemInfo(link)

	-- number = ID de l'id du roll (1, 2, 3)
	-- rollType = 0 pass, 1 need, 2 cupi, 3 dez
	-- ConfirmLootRoll(number, rollType)

	local weightCalcResult = GearHelper:weightCalculation(link)

	GearHelper:scanCharacter()

	if canNeed then
		if GearHelper.db.profile.autoNeed then
			if itemType == L["armor"] or itemType == L["weapon"] then
				if weightCalcResult[1] ~= nil then
					print("weightCalcResult[1] : "..weightCalcResult[1])
				else
					print("weightCalcResult[1] nil")
					print(weightCalcResult)
				end
				if weightCalcResult[2] ~= nil then
					print("weightCalcResult[2] : "..weightCalcResult[2])
				else
					print("weightCalcResult[2] nil")
					print(weightCalcResult)
				end

				if (weightCalcResult[1] ~= nil and weightCalcResult[1] > 0) or (weightCalcResult[2] ~= nil and weightCalcResult[2] > 0) then
					print("J'ai need 1 "..name)
					UIErrorsFrame:AddMessage(L["iNeededOn"]..name, 0.0, 1.0, 0.0, 150)          -----------          DEBUG MODE        -----------
				elseif GearHelper.db.profile.autoGreed then
					print("J'ai cupi 2 "..name)
				end
			elseif itemType == L["monture"] or itemType == L["mascotte"] then
				print("J'ai need 3 "..name)
				UIErrorsFrame:AddMessage(L["iNeededOn"]..name, 0.0, 1.0, 0.0, 80)
			end
		end
	elseif canGreed then
		if GearHelper.db.profile.autoGreed then
			for _, v in pairs( L["TypeToNotNeed"] ) do
				if itemType == v or itemSubType == v then
					do return end
				end
			end
			ConfirmLootRoll(number, 2)
		end
	end
end

--[[
Function : MerchantClosed
Scope : local
Description :
Input :
Output :
Author : Raphaël Daumas
]]
local function MerchantClosed()
	if GearHelper.db.profile.sellGreyItems then
		local argentFin = 0
		for bag = 0,4 do
			for slot = 1,GetContainerNumSlots(bag) do
				if GetContainerItemID(bag, slot) ~= nil then
					local _, itemCount = GetContainerItemInfo(bag, slot)
					local id = GetContainerItemID(bag, slot)
					if id then
						local _, _, _, _, _, _, _, _, _, _, vendorPrice = GetItemInfo(id)
						argentFin = argentFin + (vendorPrice * itemCount)
					end
				end
			end
		end
		if(gagne - argentFin > 0) then
			print(cVert..L["moneyEarned"]..math.floor((gagne - argentFin)/10000)..L["dot"]..math.floor(((gagne - argentFin) % 10000) / 100)..L["gold"])
			gagne = 0
		end
	end
end

--[[
Function : MerchantClosed
Scope : local
Description :
Input :
Output :
Author : Raphaël Daumas
]]
local function BagUpdate()
	--Random check to verify that charInventory is initialized because BagUpdate is fired before PlayerEnteringWorld
	if GearHelper.charInventory["MainHand"] ~= "" and GearHelper.charInventory["MainHand"] ~= nil then
		GearHelper:scanBag()
		GearHelper:scanCharacter()
		GearHelper:poseDot()
	end
end

--[[
Function : ActiveTalentGroupChanged
Scope : local
Description :
Input :
Output :
Author : Raphaël Daumas
]]
local function ActiveTalentGroupChanged()
	if GearHelper.db.profile.autoEquipWhenSwitchSpe then
		waitSpeTimer = time()
		waitSpeFrame:Show()
	end
end

--[[
Function : ChatMsgChannel
Scope : local
Description :
Input :
Output :
Author : Raphaël Daumas
]]
local function ChatMsgChannel(msg, sender)
	if GearHelper.db.profile.autoInvite and msg ~= nil then
		local playerIsNotMe = not string.find(sender, GetUnitName("player"))
		if msg:lower() == GearHelper.db.profile.inviteMessage:lower() and playerIsNotMe and GetNumGroupMembers() == 5 then
			ConvertToRaid()
			InviteUnit(sender)
		elseif msg:lower() == GearHelper.db.profile.inviteMessage:lower() and playerIsNotMe then
			InviteUnit(sender)
		end
	end
end

--[[
Function : ChatMsgWhisper
Scope : local
Description :
Input :
Output :
Author : Raphaël Daumas
]]
local function ChatMsgWhisper(msg, sender)
	if GearHelper.db.profile.autoInvite and msg ~= nil then
		local playerIsNotMe = not string.find(sender, GetUnitName("player"))
		if msg:lower() == GearHelper.db.profile.inviteMessage:lower() and playerIsNotMe and GetNumGroupMembers() == 5 then
			ConvertToRaid()
			InviteUnit(sender)
		elseif msg:lower() == GearHelper.db.profile.inviteMessage:lower() and playerIsNotMe then
			InviteUnit(sender)
		end
	end
end

--[[
Function : ChatMsgLoot
Scope : local
Description :
Input :
Output :
Author : Raphaël Daumas
]]
local function ChatMsgLoot(message, sender, language, channelString, target, flags, unknown1, channelNumber, channelName, unknown2, counter)
	GearHelper:createLinkAskIfHeNeeds(0, message, sender, language, channelString, target, flags, unknown1, channelNumber, channelName, unknown2, counter)

	local used = false
	for i = 1, NUM_CHAT_WINDOWS do
		local _, _, _, _, _, _, _, _, _, uninteractable = GetChatWindowInfo(i);
		if(uninteractable) then
			SetChatWindowUninteractable(i, false)
			used = true
		end
	end
	if used then
		ReloadUI()
	end
end

--[[
Function : UnitInventoryChanged
Scope : local
Description :
Input :
Output :
Author : Raphaël Daumas
]]
local function UnitInventoryChanged(joueur)
	if GearHelper.db.profile.addonEnabled and joueur == "player" then
		GearHelper:scanCharacter()
		GearHelper:scanBag()
		if GetInventoryItemLink("player",GetInventorySlotInfo("MainHandSlot")) ~= nil then
			local _, _, _, _, _, _, subclass  = GetItemInfo(GetInventoryItemLink("player",GetInventorySlotInfo("MainHandSlot")))
			if subclass == L["cannapeche"] then
				GearHelper.db.profile.autoEquipLooted.previous = GearHelper.db.profile.autoEquipLooted.actual
				GearHelper.db.profile.autoEquipLooted.actual = false
			else
				GearHelper.db.profile.autoEquipLooted.actual = GearHelper.db.profile.autoEquipLooted.previous
			end
		end
	end
end

--[[
Function : QuestTurnedIn
Scope : local
Description :
Input :
Output :
Author : Raphaël Daumas
]]
local function QuestTurnedIn()
	if GearHelper.db.profile.autoEquipLooted.actual then
		waitSpeTimer = time()
		waitSpeFrame:Show()
	end
end

--[[
Function : GetItemInfoReceived
Scope : local
Description :
Input :
Output :
Author : Raphaël Daumas
]]
local function GetItemInfoReceived(item)
	if item ~= nil then
		if GearHelper.idNilGetQuestReward ~= nil then
			if item == GearHelper.idNilGetQuestReward then
				GearHelper:Print(tostring(item).." était nil")
				coroutine.resume(GearHelper.GetQuestRewardCoroutine)
			end
		end
	end
end


	GearHelper:RegisterEvent("ADDON_LOADED", AddonLoaded, name)
	GearHelper:RegisterEvent("MERCHANT_SHOW", OnMerchantShow)
	GearHelper:RegisterEvent("PLAYER_ENTERING_WORLD", PlayerEnteringWorld)
	GearHelper:RegisterEvent("CHAT_MSG_ADDON", ChatMsgAddon, prefixMessage, message, sender)
	GearHelper:RegisterEvent("ITEM_PUSH", ItemPush, bag)
	GearHelper:RegisterEvent("QUEST_COMPLETE", QuestComplete)
	GearHelper:RegisterEvent("START_LOOT_ROLL", StartLootRoll, number)
	GearHelper:RegisterEvent("MERCHANT_CLOSED", MerchantClosed)
	GearHelper:RegisterEvent("BAG_UPDATE", BagUpdate)
	GearHelper:RegisterEvent("ACTIVE_TALENT_GROUP_CHANGED", ActiveTalentGroupChanged)
	GearHelper:RegisterEvent("CHAT_MSG_CHANNEL", ChatMsgChannel, msg, sender)
	GearHelper:RegisterEvent("CHAT_MSG_WHISPER", ChatMsgWhisper, msg, sender)
	GearHelper:RegisterEvent("CHAT_MSG_LOOT", ChatMsgLoot, message, sender, language, channelString, target, flags, unknown1, channelNumber, channelName, unknown2, counter)
	GearHelper:RegisterEvent("UNIT_INVENTORY_CHANGED", UnitInventoryChanged, joueur)
	GearHelper:RegisterEvent("QUEST_TURNED_IN", QuestTurnedIn)
	GearHelper:RegisterEvent("GET_ITEM_INFO_RECEIVED", GetItemInfoReceived, item)
